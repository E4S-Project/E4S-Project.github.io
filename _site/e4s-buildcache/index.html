<p>E4S publishes <strong>prebuilt, cryptographically signed Spack binaries</strong> (a <em>build cache</em>) for many supported platforms, compilers, and device SDKs. Using the build cache dramatically reduces install time and ensures consistency with tested E4S releases.</p>

<p>Below is a succinct, <strong>copy-paste friendly</strong> guide. You can follow it in a clean shell or inside a Spack environment.</p>

<hr />

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li><strong>Install Spack</strong> (same minor version used by the E4S release if possible).
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/spack/spack.git
<span class="nb">.</span> spack/share/spack/setup-env.sh
spack <span class="nt">-V</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Load/Discover your compilers</strong> (so your specs match cached binaries).
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module avail 2&gt;/dev/null <span class="o">||</span> <span class="nb">true</span>   <span class="c"># optional, on HPC systems</span>
spack compiler find
spack compilers
</code></pre></div>    </div>
  </li>
  <li><strong>Know your target and OS triple</strong> (to match the cache ABI):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack <span class="nb">arch
uname</span> <span class="nt">-a</span>
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>Tip: Binary compatibility is determined by OS/Libc, micro-architecture (e.g., <code class="language-plaintext highlighter-rouge">x86_64_v3</code>, <code class="language-plaintext highlighter-rouge">zen3</code>), compiler family/version, and relevant SDKs (CUDA/ROCm/oneAPI). Matching these to the E4S cache yields “install from binary” instead of “build from source”.</p>
</blockquote>

<hr />

<h2 id="step-1--pick-the-e4s-release-and-mirror-url">Step 1 — Pick the E4S release and mirror URL</h2>

<p>Decide which <strong>E4S release</strong> you intend to use (e.g., <code class="language-plaintext highlighter-rouge">25.06</code>). Your site or facility docs usually provide the exact mirror URL for that release and platform.</p>

<p>Set a variable for convenience (update as needed):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">E4S_REL</span><span class="o">=</span>25.06
<span class="nb">export </span><span class="nv">E4S_MIRROR_URL</span><span class="o">=</span><span class="s2">"https://cache.e4s.io/</span><span class="k">${</span><span class="nv">E4S_REL</span><span class="k">}</span><span class="s2">"</span>   <span class="c"># example; use your site’s URL if different</span>
</code></pre></div></div>

<blockquote>
  <p>If your center provides a <em>local</em> mirror, prefer that URL for faster downloads.</p>
</blockquote>

<hr />

<h2 id="step-2--add-the-build-cache-as-a-spack-mirror">Step 2 — Add the build cache as a Spack mirror</h2>

<p>Add the mirror at a useful scope (user/site). You can add multiple mirrors; Spack will search them in order.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack mirror add <span class="nt">--scope</span><span class="o">=</span>user e4s-<span class="k">${</span><span class="nv">E4S_REL</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">E4S_MIRROR_URL</span><span class="k">}</span><span class="s2">"</span>
spack mirror list
</code></pre></div></div>

<hr />

<h2 id="step-3--trust-e4s-signing-keys">Step 3 — Trust E4S signing keys</h2>

<p>E4S build caches are signed. Install and trust the public keys so Spack can verify binaries:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack buildcache keys <span class="nt">--install</span> <span class="nt">--trust</span>
spack gpg list  <span class="c"># confirm keys are present and trusted</span>
</code></pre></div></div>

<hr />

<h2 id="step-4--see-what-binaries-are-available">Step 4 — See what binaries are available</h2>

<p>List cache contents for a quick sanity check:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack buildcache list <span class="nt">-L</span> | <span class="nb">head</span> <span class="nt">-n</span> 30
<span class="c"># or filter:</span>
spack buildcache list <span class="nt">-L</span> | <span class="nb">grep</span> <span class="nt">-i</span> kokkos
spack buildcache list <span class="nt">-L</span> | <span class="nb">grep</span> <span class="nt">-i</span> cuda
</code></pre></div></div>

<p>To inspect a particular spec’s binary metadata:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack buildcache info kokkos@4.3.1 ^cmake
</code></pre></div></div>

<hr />

<h2 id="step-5--install-from-the-cache-single-package">Step 5 — Install from the cache (single package)</h2>

<p><strong>Spack ≥0.21</strong> supports the <code class="language-plaintext highlighter-rouge">-b/--use-buildcache</code> policy:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">-b only</code> : fail if no binary exists (never build from source)</li>
  <li><code class="language-plaintext highlighter-rouge">-b auto</code> : use a binary if present; otherwise build from source</li>
  <li><code class="language-plaintext highlighter-rouge">-b never</code>: never use binaries</li>
</ul>

<p>Examples:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use binaries when available, otherwise build:</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto kokkos +openmp %gcc@12.3.0 <span class="nv">target</span><span class="o">=</span>x86_64_v3

<span class="c"># Require a binary (good for strict reproducibility):</span>
spack <span class="nb">install</span> <span class="nt">-b</span> only petsc@3.20.3 +mpi %gcc@12.3.0
</code></pre></div></div>

<p><strong>If you’re on an older Spack</strong> that lacks <code class="language-plaintext highlighter-rouge">-b</code>, use:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack <span class="nb">install</span> <span class="nt">--use-buildcache</span> kokkos +openmp %gcc@12.3.0
</code></pre></div></div>

<hr />

<h2 id="step-6--install-from-the-cache-using-an-environment-recommended">Step 6 — Install from the cache using an environment (recommended)</h2>

<p>Environments capture your stack in <code class="language-plaintext highlighter-rouge">spack.yaml</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>e4s-env <span class="o">&amp;&amp;</span> <span class="nb">cd </span>e4s-env
spack <span class="nb">env </span>activate <span class="nt">-d</span> <span class="nb">.</span>

<span class="c"># Create a simple environment file:</span>
<span class="nb">cat</span> <span class="o">&gt;</span> spack.yaml <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">YAML</span><span class="sh">'
spack:
  specs:
  - kokkos +openmp
  - hypre +mpi
  - petsc +mpi ~cuda
  concretizer:
    unify: true
  view: false
</span><span class="no">YAML

</span><span class="c"># Concretize and install, preferring binaries:</span>
spack concretize <span class="nt">-f</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto
</code></pre></div></div>

<p>Optional quality-of-life:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Generate Lmod/Tcl modules for the new installs</span>
spack module lmod refresh <span class="nt">-y</span>   <span class="c"># or: spack module tcl refresh -y</span>

<span class="c"># What got installed and from where:</span>
spack find <span class="nt">-vb</span>      <span class="c"># shows versions and whether installed from binary</span>
</code></pre></div></div>

<hr />

<h2 id="step-7--verify-and-optionally-fetch-without-installing">Step 7 — Verify and (optionally) fetch without installing</h2>

<ul>
  <li><strong>Verify signatures and checksums</strong> of cached packages you’ve installed:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack buildcache verify <span class="nt">--rebuild-index</span><span class="o">=</span><span class="nb">false</span> <span class="si">$(</span>spack find <span class="nt">--format</span> <span class="s1">'{hash}'</span> &lt;spec&gt;<span class="si">)</span>
</code></pre></div>    </div>
  </li>
  <li><strong>Download a cached tarball</strong> to inspect (without installing):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spack buildcache get kokkos@4.3.1 %gcc@12.3.0
<span class="nb">ls</span> <span class="nt">-lh</span> ./build_cache
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<h2 id="step-8--gpusdk-aware-installs-cudarocmoneapi">Step 8 — GPU/SDK-aware installs (CUDA/ROCm/oneAPI)</h2>

<p>Match your device SDK to the cache:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># NVIDIA CUDA example</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto kokkos +cuda <span class="nv">cuda_arch</span><span class="o">=</span>80 %gcc@12.3.0

<span class="c"># AMD ROCm example</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto kokkos +rocm <span class="nv">amdgpu_target</span><span class="o">=</span>gfx90a %gcc@12.3.0

<span class="c"># Intel oneAPI example</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto oneapi-mkl %oneapi
</code></pre></div></div>

<blockquote>
  <p>If the cache was built with different SDK versions or GPU targets than your system, Spack will either fall back to source builds (with <code class="language-plaintext highlighter-rouge">-b auto</code>) or fail (with <code class="language-plaintext highlighter-rouge">-b only</code>). Choose the policy that matches your intent.</p>
</blockquote>

<hr />

<h2 id="common-pitfalls--how-to-fix-them">Common pitfalls &amp; how to fix them</h2>

<ul>
  <li>
    <p><strong>“No binary for spec”</strong><br />
The cache doesn’t have your exact ABI tuple (OS/libc, micro-arch, compiler, SDK).<br />
<em>Fix:</em> Adjust your spec (compiler version, targets like <code class="language-plaintext highlighter-rouge">target=x86_64_v3</code> or <code class="language-plaintext highlighter-rouge">target=zen3</code>, GPU arch), or allow source builds (<code class="language-plaintext highlighter-rouge">-b auto</code>). Confirm with <code class="language-plaintext highlighter-rouge">spack buildcache list -L</code>.</p>
  </li>
  <li>
    <p><strong>“Signature verification failed”</strong><br />
Keys weren’t installed/trusted.<br />
<em>Fix:</em> Re-run <code class="language-plaintext highlighter-rouge">spack buildcache keys --install --trust</code> and try again.</p>
  </li>
  <li>
    <p><strong>“Different Spack version/lock format”</strong><br />
Using a substantially different Spack version than the cache was built with can cause misses.<br />
<em>Fix:</em> Use the Spack version recommended for the E4S release, or let Spack build from source.</p>
  </li>
  <li>
    <p><strong>“Wrong compiler toolchain/module loaded”</strong><br />
Your environment modules can influence concretization.<br />
<em>Fix:</em> Load the intended compiler/module set before <code class="language-plaintext highlighter-rouge">spack concretize</code> or pin compilers in <code class="language-plaintext highlighter-rouge">spack.yaml</code>.</p>
  </li>
  <li>
    <p><strong>“CUDA/ROCm target mismatch”</strong><br />
GPU arch flags don’t match the cache.<br />
<em>Fix:</em> Set <code class="language-plaintext highlighter-rouge">cuda_arch</code> / <code class="language-plaintext highlighter-rouge">amdgpu_target</code> to match cached builds (or your hardware if you accept source builds).</p>
  </li>
</ul>

<hr />

<h2 id="useful-commands-cheat-sheet">Useful commands (cheat sheet)</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Show mirrors and keys</span>
spack mirror list
spack gpg list

<span class="c"># Search for packages and their variants</span>
spack list kokkos
spack info kokkos

<span class="c"># Inspect binary metadata and availability</span>
spack buildcache list <span class="nt">-L</span> | <span class="nb">grep</span> <span class="nt">-i</span> petsc
spack buildcache info petsc@3.20.3

<span class="c"># Install policies</span>
spack <span class="nb">install</span> <span class="nt">-b</span> only &lt;spec&gt;    <span class="c"># require binary</span>
spack <span class="nb">install</span> <span class="nt">-b</span> auto &lt;spec&gt;    <span class="c"># prefer binary, build if needed</span>

<span class="c"># After install</span>
spack find <span class="nt">-vb</span>
spack module lmod refresh <span class="nt">-y</span>
</code></pre></div></div>

<hr />

<h2 id="faq">FAQ</h2>

<p><strong>Do I have to use the exact E4S release of Spack?</strong><br />
It’s strongly recommended for maximal binary hit-rate. Minor mismatches can still work but may reduce cache usage.</p>

<p><strong>Can I mix cached and source builds?</strong><br />
Yes. Use <code class="language-plaintext highlighter-rouge">-b auto</code> (or <code class="language-plaintext highlighter-rouge">--use-buildcache</code> on older Spack). This is a good default while you’re aligning your specs with the cache.</p>

<p><strong>Where do I find the mirror URL for my site?</strong><br />
Check your facility’s E4S/Spack docs or the E4S release notes. Many sites host a local mirror for performance and air-gap compliance.</p>

<p><strong>How do I stay fully reproducible?</strong><br />
Use environments, lockfiles (<code class="language-plaintext highlighter-rouge">spack.lock</code>), and <code class="language-plaintext highlighter-rouge">spack install -b only</code>. Pin compilers and SDK versions. Export your <code class="language-plaintext highlighter-rouge">spack.yaml</code> alongside your project.</p>

<hr />

<h3 id="summary">Summary</h3>

<ul>
  <li>Add the <strong>E4S mirror</strong>, <strong>trust keys</strong>, and <strong>install with <code class="language-plaintext highlighter-rouge">-b auto</code></strong> for a smooth experience.</li>
  <li>For strict reproducibility, <strong>use environments</strong> and <strong><code class="language-plaintext highlighter-rouge">-b only</code></strong>.</li>
  <li>Match <strong>OS/arch/compiler/SDK</strong> to maximize binary reuse and avoid rebuilding from source.</li>
</ul>
